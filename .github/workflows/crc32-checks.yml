name: CRC32 7-Zip parity checks (Windows)

on:
  push:
    branches:
      - '**'

jobs:
  crc32-7zip-parity-integration:
    name: Run CRC32 parity integration tests against 7-Zip
    runs-on: windows-latest
    defaults:
      run:
        shell: powershell

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install 7-Zip (prefer 25.01)
        run: |
          $ErrorActionPreference = 'Stop'
          choco install 7zip --version=25.1 -y --no-progress
          if ($LASTEXITCODE -ne 0) {
            Write-Host '7-Zip 25.01 install failed; falling back to latest 7zip package.'
            choco install 7zip -y --no-progress
            if ($LASTEXITCODE -ne 0) {
              throw 'Unable to install 7-Zip via Chocolatey.'
            }
          }

          $sevenZipPath = 'C:\Program Files\7-Zip\7z.exe'
          if (-not (Test-Path -LiteralPath $sevenZipPath)) {
            $cmd = Get-Command 7z -ErrorAction SilentlyContinue
            if (-not $cmd) {
              throw '7z executable not found after installation.'
            }
            $sevenZipPath = $cmd.Source
          }

          & $sevenZipPath | Select-Object -First 2 | ForEach-Object { Write-Host $_ }
          "SEVEN_ZIP_EXE=$sevenZipPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Install Pester test framework
        run: |
          $ErrorActionPreference = 'Stop'
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          Install-Module Pester -Scope CurrentUser -Force -SkipPublisherCheck -RequiredVersion 5.6.1

      - name: Execute CRC32 integration test suite
        run: |
          $ErrorActionPreference = 'Stop'
          $config = New-PesterConfiguration
          $config.Run.Path = 'tests/Crc32.Integration.Tests.ps1'
          $config.Output.Verbosity = 'Detailed'
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = 'TestResults.xml'
          $config.TestResult.OutputFormat = 'NUnitXml'
          $result = Invoke-Pester -Configuration $config
          if ($result.FailedCount -gt 0) {
            throw "Pester failed: $($result.FailedCount) test(s) failed."
          }

      - name: Upload CRC32 verification artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crc32-verification-artifacts
          if-no-files-found: warn
          path: |
            TestResults.xml
            test-artifacts/**
